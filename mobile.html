<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>棋士データ（PC/スマホ切替）</title>
  <link rel="stylesheet" href="style.css" />
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<div class="wrapper">
  <h1>棋士データ</h1>

  <!-- PCビュー：全列テーブル -->
  <div id="pc-view">
    <div class="section-title">PCビュー（全列表示）</div>
    <div id="pc-table-wrap">読み込み中...</div>
  </div>

  <!-- モバイルビュー：選んだ基準で2列表示 -->
  <div id="mobile-view">
    <div class="section-title">スマホビュー（名前＋選択した基準）</div>

    <div class="controls">
      <select id="criterion">
  <option value="" selected disabled>-- 並び替え基準を選択 --</option>
  <option value="kishiNumber">棋士番号</option>
  <option value="birthdate">生年月日</option>
  <option value="currentAge">現年齢</option>
  <option value="ageAtPromotion">四段昇段時の年齢</option>
</select>

      <button id="applySort">並び替える</button>

      <div class="order">
        <label><input type="radio" name="ord" value="asc" checked> 昇順</label>
        <label><input type="radio" name="ord" value="desc"> 降順</label>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>棋士名</th>
          <th id="col-label">基準</th>
        </tr>
      </thead>
      <tbody id="mobile-tbody"></tbody>
    </table>
  </div>
</div>

<script>
  // ===== ユーティリティ =====
  const parseDate = (s) => {
    // "YYYY-MM-DD" 前提
    const [y, m, d] = s.split('-').map(n => parseInt(n, 10));
    return new Date(y, m - 1, d);
  };
  const formatAge = (birth, ref = new Date()) => {
    let age = ref.getFullYear() - birth.getFullYear();
    const hasNotHadBirthday =
      (ref.getMonth() < birth.getMonth()) ||
      (ref.getMonth() === birth.getMonth() && ref.getDate() < birth.getDate());
    if (hasNotHadBirthday) age--;
    return age; // 数値（歳）
  };
  const ageAtDate = (birth, date) => {
    let age = date.getFullYear() - birth.getFullYear();
    const hasNotHadBirthday =
      (date.getMonth() < birth.getMonth()) ||
      (date.getMonth() === birth.getMonth() && date.getDate() < birth.getDate());
    if (hasNotHadBirthday) age--;
    return age;
  };

  // ===== CSV読み込み → データ整形 =====
  let rows = [];  // オリジナル順
  let headerIndex = {}; // 列名→インデックス
  let people = []; // オブジェクト配列で扱いやすく

  fetch('kishi.csv')
    .then(r => r.text())
    .then(text => {
      const lines = text.trim().split('\n').map(l => l.split(','));
      const headers = lines[0];
      rows = lines.slice(1);

      // 柔軟に列を拾えるよう、見出しの場所を記録
      headers.forEach((h, i) => headerIndex[h] = i);

      // 必要列名（あなたのCSV見出しに合わせて）
      // 例：名前, 生年月日, 四段昇段日, 棋士番号
      const nameKey      = '棋士名';
      const birthKey     = '生年月日';
      const promoteKey   = '四段昇段日';
      const noKey        = '棋士番号';

      people = rows.map(cols => {
        const name = cols[headerIndex[nameKey]];
        const birthStr = cols[headerIndex[birthKey]];
        const promStr  = cols[headerIndex[promoteKey]];
        const noStr    = cols[headerIndex[noKey]];

        const birth = birthStr ? parseDate(birthStr) : null;
        const prom  = promStr ? parseDate(promStr) : null;

        return {
          name,
          birthStr, promStr, noStr,
          birth, prom,
          currentAge: birth ? formatAge(birth) : null,
          ageAtPromotion: (birth && prom) ? ageAtDate(birth, prom) : null
        };
      });

      renderPCTable(headers, rows);
      
      // （追加）最初は「棋士名のみ」表示
renderMobileInitial();
    })
    .catch(err => {
      document.getElementById('pc-table-wrap').textContent = 'CSV読み込み失敗: ' + err;
    });

  // ===== PCテーブル（全列表示） =====
  function renderPCTable(headers, rows) {
    const tableHTML = `
      <table>
        <thead>
          <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
        </thead>
        <tbody>
          ${rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}
        </tbody>
      </table>`;
    document.getElementById('pc-table-wrap').innerHTML = tableHTML;
  }

  // ===== モバイル描画（2列：名前 + 選択基準） =====
  const labelMap = {
    kishiNumber: '棋士番号',
    birthdate: '生年月日',
    currentAge: '現年齢',
    ageAtPromotion: '四段昇段時の年齢'
  };

  function renderMobileInitial() {
  const tbody = document.getElementById('mobile-tbody');
  const colLabel = document.getElementById('col-label');
  colLabel.textContent = '基準'; // 未選択時の見出し
  tbody.innerHTML = people.map(p => `
    <tr>
      <td>${p.name}</td>
      <td></td>
    </tr>
  `).join('');
}
  
  function applyMobileSort() {
    const criterion = document.getElementById('criterion').value;
  if (!criterion) {
    // 何も選んでいなければ何もしない（アラートなし）
    return;
    const criterion = document.getElementById('criterion').value;
    const order = document.querySelector('input[name="ord"]:checked').value; // asc | desc
    const tbody = document.getElementById('mobile-tbody');
    const colLabel = document.getElementById('col-label');
    colLabel.textContent = labelMap[criterion];

    // ソート用のキー関数
    const key = (p) => {
      switch (criterion) {
        case 'kishiNumber':      return p.noStr ? Number(p.noStr) : Number.POSITIVE_INFINITY;
        case 'birthdate':        return p.birth ? p.birth.getTime() : Number.POSITIVE_INFINITY;
        case 'currentAge':       return (p.currentAge ?? Number.POSITIVE_INFINITY);
        case 'ageAtPromotion':   return (p.ageAtPromotion ?? Number.POSITIVE_INFINITY);
        default: return 0;
      }
    };

    const sorted = [...people].sort((a, b) => {
      const A = key(a), B = key(b);
      if (A === B) return 0;
      return (A < B ? -1 : 1) * (order === 'asc' ? 1 : -1);
    });

    // 描画（選んだ基準だけを表示）
    tbody.innerHTML = sorted.map(p => `
      <tr>
        <td>${p.name}</td>
        <td>${
          criterion === 'kishiNumber'    ? (p.noStr ?? '') :
          criterion === 'birthdate'      ? (p.birthStr ?? '') :
          criterion === 'currentAge'     ? (p.currentAge !== null ? `${p.currentAge}歳` : '') :
          /* ageAtPromotion */             (p.ageAtPromotion !== null ? `${p.ageAtPromotion}歳` : '')
        }</td>
      </tr>
    `).join('');
  }

  document.getElementById('applySort').addEventListener('click', applyMobileSort);
</script>
</body>
</html>
