<!DOCTYPE html><html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>棋士データ検索（モバイル）</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<h1>棋士データ検索</h1>
<div>
  <label><input type="checkbox" id="activeOnly" checked> 現役棋士のみ表示</label>
  <select id="sort-select">
    <option value="dan">段位</option>
    <option value="kishiNumber">棋士番号</option>
    <option value="birthdate">生年月日</option>
    <option value="currentAge">現年齢</option>
    <option value="ageAtPromotion">四段昇段時年齢</option>
  </select>
  <label><input type="radio" name="sortOrder" value="asc" checked> 昇順</label>
  <label><input type="radio" name="sortOrder" value="desc"> 降順</label>
</div>
<table id="mobile-table">
  <thead><tr id="thead-row">
    <th class="rank">順位</th>
    <th>棋士名</th>
    <th id="col-label">段位</th>
  </tr></thead>
  <tbody></tbody>
</table><script>
let people = [];
let currentSortOrder = 'asc';

async function loadData(){
  const res = await fetch('kishi.csv');
  const text = await res.text();
  const rows = text.trim().split(/\n/).map(r=>r.split(','));
  const header = rows.shift();
  const idx = name => header.findIndex(h=>h === name);
  people = rows.map(cols=>({
    status: cols[idx('状態')],
    noStr: cols[idx('棋士番号')],
    noNum: Number(cols[idx('棋士番号')]),
    name: cols[idx('棋士名')],
    dan: cols[idx('段位')],
    birthStr: cols[idx('生年月日')]||'',
    birth: cols[idx('生年月日')]?new Date(cols[idx('生年月日')]):null,
    titleRank: cols[idx('タイトル保持者')],
    promoDate: cols[idx('四段昇段日')]?new Date(cols[idx('四段昇段日')]):null,
    promoAgeDays: cols[idx('昇段日数')]?Number(cols[idx('昇段日数')]):null,
    currentAgeDays: cols[idx('現在日数')]?Number(cols[idx('現在日数')]):null
  }));
}

const stateOrderAsc = {"現役":1,"引退":2,"物故":3,"退会":4};
const rankOrderMap = {"九段":9,"八段":8,"七段":7,"六段":6,"五段":5,"四段":4};

function getDanPromotionDate(p){
  return p.promoDate || null;
}

function renderMobileTable(data, criterion=""){
  const tbody = document.querySelector('#mobile-table tbody');
  tbody.innerHTML = data.map((p,i)=>{
    let third =
      criterion==='kishiNumber'?p.noStr:
      criterion==='birthdate'?p.birthStr:
      criterion==='currentAge'?(p.currentAgeDays?Math.floor(p.currentAgeDays/365)+"歳":""):
      criterion==='ageAtPromotion'?(p.promoAgeDays?Math.floor(p.promoAgeDays/365)+"歳":""):
      p.dan;
    return `<tr><td class="rank">${i+1}</td><td>${p.name}</td><td>${third}</td></tr>`;
  }).join('');
}

function renderMobileInitial(){
  document.getElementById('col-label').textContent = '段位';
  const sorted = [...getFilteredPeople()].sort((a,b)=>{
    const as = stateOrderAsc[a.status] ?? 99;
    const bs = stateOrderAsc[b.status] ?? 99;
    if (as !== bs) return as - bs;

    if (a.status === '現役') {
      const at = a.titleRank ? Number(a.titleRank) : Infinity;
      const bt = b.titleRank ? Number(b.titleRank) : Infinity;
      if (at !== bt) return at - bt;

      const ar = rankOrderMap[a.dan] ?? 0;
      const br = rankOrderMap[b.dan] ?? 0;
      if (ar !== br) return br - ar;

      const ad = getDanPromotionDate(a);
      const bd = getDanPromotionDate(b);
      const av = ad ? ad.getTime() : Infinity;
      const bv = bd ? bd.getTime() : Infinity;
      if (av !== bv) return av - bv;
      return a.noNum - b.noNum;
    }
    return a.noNum - b.noNum;
  });
  renderMobileTable(sorted, 'dan');
}

function getFilteredPeople(){
  const activeOnly = document.getElementById('activeOnly').checked;
  return activeOnly ? people.filter(p=>p.status==='現役') : people;
}

document.getElementById('sort-select').addEventListener('change', applyMobileSort);
document.querySelectorAll('input[name="sortOrder"]').forEach(r=>r.addEventListener('change', applyMobileSort));
document.getElementById('activeOnly').addEventListener('change', renderMobileInitial);

function applyMobileSort(){
  const criterion = document.getElementById('sort-select').value;
  currentSortOrder=document.querySelector('input[name="sortOrder"]:checked').value;
  const sorted = [...getFilteredPeople()].sort((a,b)=>{
    switch(criterion){
      case 'kishiNumber': return currentSortOrder==='asc'?a.noNum-b.noNum:b.noNum-a.noNum;
      case 'birthdate': return currentSortOrder==='asc'?(a.birth?.getTime()??Infinity)-(b.birth?.getTime()??Infinity):(b.birth?.getTime()??Infinity)-(a.birth?.getTime()??Infinity);
      case 'currentAge': return currentSortOrder==='asc'?a.currentAgeDays-b.currentAgeDays:b.currentAgeDays-a.currentAgeDays;
      case 'ageAtPromotion': return currentSortOrder==='asc'?a.promoAgeDays-b.promoAgeDays:b.promoAgeDays-a.promoAgeDays;
      case 'dan': {
        const aState=stateOrderAsc[a.status]??99;
        const bState=stateOrderAsc[b.status]??99;
        if(aState!==bState) return currentSortOrder==='asc'?aState-bState:bState-aState;

        if(a.status==='現役'){
          const aTitle=a.titleRank?Number(a.titleRank):Infinity;
          const bTitle=b.titleRank?Number(b.titleRank):Infinity;
          if(aTitle!==bTitle) return currentSortOrder==='asc'?aTitle-bTitle:bTitle-aTitle;

          const aRank=rankOrderMap[a.dan]??0;
          const bRank=rankOrderMap[b.dan]??0;
          if(aRank!==bRank) return currentSortOrder==='asc'?bRank-aRank:aRank-bRank;

          const aDate=getDanPromotionDate(a)?.getTime()??Infinity;
          const bDate=getDanPromotionDate(b)?.getTime()??Infinity;
          return currentSortOrder==='asc'?aDate-bDate:bDate-aDate;
        }
        return currentSortOrder==='asc'?a.noNum-b.noNum:b.noNum-a.noNum;
      }
      default: return 0;
    }
  });
  renderMobileTable(sorted, criterion);
}

loadData().then(renderMobileInitial);
</script></body>
</html>