<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>棋士データ検索（スマホ版）</title>
  <link rel="stylesheet" href="style.css?v=cardfix2">
  
</head>
<body>
  <h1>棋士データ検索（スマホ版）</h1>

  <div class="controls">
    <label for="sort-select">並び替え基準:</label>
    <select id="sort-select">
      <option value="">-- 並び替え未選択 --</option>
      <option value="kishiNumber">棋士番号</option>
      <option value="birthdate">生年月日</option>
      <option value="currentAge">現年齢</option>
      <option value="ageAtPromotion">四段昇段時年齢</option>
      <option value="dan">段位</option>
    </select>
    <div>
      <label><input type="radio" name="sortOrder" value="asc" checked> 昇順</label>
      <label><input type="radio" name="sortOrder" value="desc"> 降順</label>
    </div>

    <!-- 表示モード切替 + サマリ -->
    <div class="view-toggle" role="group" aria-label="表示モード">
      <label><input type="radio" name="viewMode" id="view-table" value="table" checked> 一覧</label>
      <label><input type="radio" name="viewMode" id="view-card"  value="card"> カード</label>
    </div>
    <div id="status-summary" class="status-summary" aria-live="polite"></div>

    <label style="display:block;margin:.4em 0;">
      <input type="checkbox" id="m-activeOnly" checked> 現役のみ表示
    </label>
    <button type="button" onclick="applyMobileSort()">並び替える</button>
  </div>

  <table id="mobile-table">
    <thead>
      <tr id="thead-row"></tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- カード表示用 -->
  <div id="card-container" class="cards" hidden></div>

  <p style="margin-top:1em; display:flex; justify-content:space-between; align-items:center;">
    <a href="index.html?force=1">▶ PC版を表示</a>
    <a href="#" id="scrollTopLink">▲ トップへ戻る</a>
  </p>

<script>
  // トップへ戻る
  document.getElementById('scrollTopLink').addEventListener('click', (e) => {
    e.preventDefault();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
</script>

<script>
let people = [];
let currentSortOrder = 'asc';
let currentView = localStorage.getItem('viewMode') || 'table'; // 'table' | 'card'

const labelMap = {
  kishiNumber: "棋士番号",
  birthdate: "生年月日",
  currentAge: "現年齢",
  ageAtPromotion: "四段昇段時年齢",
  dan: "段位"
};

const stateOrderAsc = { "現役": 0, "引退": 1, "物故": 2, "退会": 3 };
const rankOrderMap   = { "九段": 9, "八段": 8, "七段": 7, "六段": 6, "五段": 5, "四段": 4 };

/* ===== 補助関数 ===== */
function parseDate(str){ const d=new Date(str); return isNaN(d)?null:d; }
function toNumber(str){ const n=Number(str); return isNaN(n)?Infinity:n; }
function diffYMD(a,b){
  if(!a||!b)return null;
  let y=b.getFullYear()-a.getFullYear(),
      m=b.getMonth()-a.getMonth(),
      d=b.getDate()-a.getDate();
  if(d<0){
    const pm=new Date(b.getFullYear(), b.getMonth(), 0);
    d+=pm.getDate(); m--;
  }
  if(m<0){ m+=12; y--; }
  return {y,m,d};
}
function formatYMD(p){ return p?`${p.y}歳${p.m}ヶ月${p.d}日`:''; }

// 現在段位の到達日
function getDanPromotionDate(p){
  switch(p.dan){
    case '九段': return p.d9 || null;
    case '八段': return p.d8 || null;
    case '七段': return p.d7 || null;
    case '六段': return p.d6 || null;
    case '五段': return p.d5 || null;
    case '四段': return p.prom || null;
    default: return null;
  }
}

/* ===== データ読み込み ===== */
async function loadData(){
  const res  = await fetch('kishi.csv');
  const text = await res.text();

  const rows = text.trim().split(/\r?\n/).map(r=>r.split(','));
  const header = rows.shift();
  const idx = name => header.findIndex(h=>h===name);
  const today = new Date();

  people = rows.map(cols=>{
    const birth = parseDate(cols[idx('生年月日')]);
    const prom  = parseDate(cols[idx('四段昇段日')]);
    const d5 = parseDate(cols[idx('五段昇段日')]);
    const d6 = parseDate(cols[idx('六段昇段日')]);
    const d7 = parseDate(cols[idx('七段昇段日')]);
    const d8 = parseDate(cols[idx('八段昇段日')]);
    const d9 = parseDate(cols[idx('九段昇段日')]);

    return {
      name:      (cols[idx('棋士名')]||'').trim(),
      birthStr:  (cols[idx('生年月日')]||'').trim(),
      promStr:   (cols[idx('四段昇段日')]||'').trim(),
      noStr:     (cols[idx('棋士番号')]||'').trim(),
      noNum:     toNumber(cols[idx('棋士番号')]),
      dan:       (cols[idx('段位')]||'').trim(),
      // ★ タイトル保持者ランク（1が最上位、空は未保持→Infinity扱い）
      titleRank: (cols[idx('タイトル保持者')]||'').trim(),
      // 状態（現役/引退/物故/退会）
      status:    ((cols[idx('状態')]||'現役')).trim(),

      birth, prom, d5, d6, d7, d8, d9,
      currentAgeParts: birth ? diffYMD(birth,today) : null,
      promoAgeParts: (birth&&prom) ? diffYMD(birth,prom) : null,
      currentAgeDays: birth ? Math.floor((today-birth)/86400000) : Infinity,
      promoAgeDays: (birth&&prom) ? Math.floor((prom-birth)/86400000) : Infinity
    };
  });
}

/* ===== 段位系の標準並び（元仕様に復元） =====
   昇順：
   1) 状態（現役優先）
   2) 現役内で titleRank 昇順（1が最上位、空=Infinity=末尾）
   3) 段位は「九→四」（rankOrderMapは9>4だが比較を逆にする）
   4) 現在段位の到達日（早いほうが上）
   5) 棋士番号
*/
function sortByDan(list, order='asc'){
  const asc = (order==='asc');
  return [...list].sort((a,b)=>{
    // 1) 状態
    const as = stateOrderAsc[a.status] ?? 99;
    const bs = stateOrderAsc[b.status] ?? 99;
    if (as !== bs) return asc ? as - bs : bs - as;

    // 2) 現役内はタイトル保持者優先（1が最上位、空はInfinity）
    if (a.status === '現役' && b.status === '現役') {
      const at = a.titleRank ? Number(a.titleRank) : Infinity;
      const bt = b.titleRank ? Number(b.titleRank) : Infinity;
      if (at !== bt) return asc ? at - bt : bt - at;

      // 3) 段位（昇順=九→四）。rankOrderMapは数が大きいほど高段位なので比較を逆に
      const ar = rankOrderMap[a.dan] ?? 0;
      const br = rankOrderMap[b.dan] ?? 0;
      if (ar !== br) return asc ? br - ar : ar - br;

      // 4) 現段位の到達日（早い=小さいほど上）
      const ad = getDanPromotionDate(a);
      const bd = getDanPromotionDate(b);
      const av = ad ? ad.getTime() : Infinity;
      const bv = bd ? bd.getTime() : Infinity;
      if (av !== bv) return asc ? av - bv : bv - av;

      // 5) 棋士番号
      return asc ? a.noNum - b.noNum : b.noNum - a.noNum;
    }

    // 現役以外（引退・物故・退会）は棋士番号で並べる
    return asc ? a.noNum - b.noNum : b.noNum - a.noNum;
  });
}

/* ===== 表描画 ===== */
function renderInitialTable(data){
  const thead = document.getElementById('thead-row');
  thead.innerHTML = `
    <th class="rank">順位</th>
    <th>棋士名</th>
    <th id="col-label">段位</th>
  `;
  const tbody = document.querySelector('#mobile-table tbody');
  tbody.innerHTML = data.map((p,i)=>`
    <tr>
      <td class="rank">${i+1}</td>
      <td>${p.name}</td>
      <td>${p.dan || ''}</td>
    </tr>
  `).join('');
}

function renderSortedTable(data, criterion){
  const labels = {
    kishiNumber: '棋士番号',
    birthdate: '生年月日',
    currentAge: '現年齢',
    ageAtPromotion: '四段昇段時年齢',
    dan: '段位'
  };
  const thead = document.getElementById('thead-row');
  thead.innerHTML = `
    <th class="rank">順位</th>
    <th>棋士名</th>
    <th id="col-label">${labels[criterion] || '段位'}</th>
  `;
  const tbody = document.querySelector('#mobile-table tbody');
  tbody.innerHTML = data.map((p,i)=>{
    let third = '';
    switch(criterion){
      case 'kishiNumber': third = p.noStr || ''; break;
      case 'birthdate': third = p.birthStr || ''; break;
      case 'currentAge': third = p.currentAgeParts ? formatYMD(p.currentAgeParts) : ''; break;
      case 'ageAtPromotion': third = p.promoAgeParts ? formatYMD(p.promoAgeParts) : ''; break;
      case 'dan': default: third = p.dan || ''; break;
    }
    return `
      <tr>
        <td class="rank">${i+1}</td>
        <td>${p.name}</td>
        <td>${third}</td>
      </tr>
    `;
  }).join('');
}

/* ===== カード描画・サマリ・表示切替 ===== */
function renderCards(data, criterion) {
  const wrap = document.getElementById('card-container');
  if (!data || data.length === 0) {
    wrap.innerHTML = `<div class="empty-state">該当する棋士がいません</div>`;
    return;
  }
  wrap.innerHTML = data.map(p => {
    const statusClass = (p.status === '現役') ? 'pill-status' : 'pill-status retired';
    const third =
      criterion === 'kishiNumber'    ? (p.noStr || '') :
      criterion === 'birthdate'      ? (p.birthStr || '') :
      criterion === 'currentAge'     ? (p.currentAgeParts ? formatYMD(p.currentAgeParts) : '') :
      criterion === 'ageAtPromotion' ? (p.promoAgeParts ? formatYMD(p.promoAgeParts) : '') :
                                       (p.dan || '');

    return `
      <article class="card">
        <div class="card-header">
          <div class="card-name">${p.name}</div>
          <div class="badge-dan">${p.dan || ''}</div>
          <div class="${statusClass}">${p.status}</div>
        </div>
        <div class="card-body">
          <div class="card-meta">棋士番号：${p.noStr || '-'}</div>
          <div>${labelMap[criterion || 'dan'] || '段位'}：${third || '-'}</div>
          ${p.promStr ? `<div>四段昇段日：${p.promStr}</div>` : ''}
          ${p.currentAgeParts ? `<div>現年齢：${formatYMD(p.currentAgeParts)}</div>` : ''}
        </div>
      </article>
    `;
  }).join('');
}

function updateStatusSummary(list, criterion) {
  const sum = document.getElementById('status-summary');
  if (!sum) return;
  const orderRadio = document.querySelector('input[name="sortOrder"]:checked');
  const order = orderRadio ? orderRadio.value : 'asc';
  const orderLabel = (order === 'asc') ? '昇順' : '降順';
  const activeOnly = document.getElementById('m-activeOnly').checked;
  const critLabel = criterion ? (labelMap[criterion] || '段位') : '段位';
  const viewLabel = (currentView === 'card') ? 'カード' : '一覧';
  sum.textContent = `表示：${viewLabel} ／ 並び：${critLabel}・${orderLabel} ／ 条件：${activeOnly ? '現役のみ' : 'すべて'} ／ 件数：${(list || []).length}`;
}

function setViewMode(mode) {
  currentView = mode;
  localStorage.setItem('viewMode', mode);
  const tableEl = document.getElementById('mobile-table');
  const cardEl  = document.getElementById('card-container');
  if (mode === 'card') {
    if (tableEl) tableEl.style.display = 'none';
    if (cardEl)  cardEl.hidden = false;
  } else {
    if (tableEl) tableEl.style.display = 'table';
    if (cardEl)  cardEl.hidden = true;
  }
}

/* ===== 初期表示＆操作 ===== */
function getFilteredPeople(){
  return document.getElementById('m-activeOnly').checked
    ? people.filter(p=>p.status==='現役')
    : people;
}

function renderMobileInitial(){
  const base = sortByDan(getFilteredPeople(), 'asc');
  if (currentView === 'card') {
    renderCards(base, 'dan');
  } else {
    renderInitialTable(base);
  }
  updateStatusSummary(base, 'dan');
}

function applyMobileSort(){
  const orderRadio = document.querySelector('input[name="sortOrder"]:checked');
  currentSortOrder = orderRadio ? orderRadio.value : 'asc';
  const criterion = document.getElementById('sort-select').value;

  const base = getFilteredPeople();
  let sorted;
  switch(criterion){
    case 'kishiNumber':
      sorted = [...base].sort((a,b)=> currentSortOrder==='asc' ? a.noNum-b.noNum : b.noNum-a.noNum);
      break;
    case 'birthdate':
      sorted = [...base].sort((a,b)=>{
        const av=a.birth ? a.birth.getTime() : Infinity;
        const bv=b.birth ? b.birth.getTime() : Infinity;
        return currentSortOrder==='asc' ? av-bv : bv-av;
      });
      break;
    case 'currentAge':
      sorted = [...base].sort((a,b)=> currentSortOrder==='asc' ? a.currentAgeDays-b.currentAgeDays : b.currentAgeDays-a.currentAgeDays);
      break;
    case 'ageAtPromotion':
      sorted = [...base].sort((a,b)=> currentSortOrder==='asc' ? a.promoAgeDays-b.promoAgeDays : b.promoAgeDays-a.promoAgeDays);
      break;
    case 'dan':
      sorted = sortByDan(base, currentSortOrder);
      break;
    default:
      sorted = sortByDan(base, currentSortOrder);
      break;
  }

  if (currentView === 'card') {
    renderCards(sorted, criterion || 'dan');
  } else {
    renderSortedTable(sorted, criterion || 'dan');
  }
  updateStatusSummary(sorted, criterion || 'dan');
}

(async()=>{
  await loadData();
  setViewMode(currentView);
  const vt = document.getElementById('view-table');
  const vc = document.getElementById('view-card');
  if (vt && vc) { if (currentView==='card'){ vc.checked=true; } else { vt.checked=true; } }
  renderMobileInitial();

  // 現役のみ切替
  document.getElementById('m-activeOnly').addEventListener('change', ()=>{
    const criterion = document.getElementById('sort-select').value || 'dan';
    if (!document.getElementById('sort-select').value) {
      renderMobileInitial();
    } else {
      applyMobileSort();
    }
  });

  // 表示モード切替
  document.getElementById('view-table').addEventListener('change', (e)=>{
    if (e.target.checked) {
      setViewMode('table');
      const c = document.getElementById('sort-select').value || 'dan';
      const base = getFilteredPeople();
      const list = (c==='dan') ? sortByDan(base, currentSortOrder) : base;
      if (c==='dan') renderInitialTable(list); else renderSortedTable(list, c);
      updateStatusSummary(list, c);
    }
  });
  document.getElementById('view-card').addEventListener('change', (e)=>{
    if (e.target.checked) {
      setViewMode('card');
      const c = document.getElementById('sort-select').value || 'dan';
      const base = getFilteredPeople();
      const list = (c==='dan') ? sortByDan(base, currentSortOrder) : base;
      renderCards(list, c);
      updateStatusSummary(list, c);
    }
  });
})();
</script>
</body>
</html>
