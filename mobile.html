<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>æ£‹å£«ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ï¼ˆã‚¹ãƒãƒ›ç‰ˆï¼‰</title>
  <link rel="stylesheet" href="style.css?v=cardfix2">
</head>
<body>
  <h1>æ£‹å£«ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ï¼ˆã‚¹ãƒãƒ›ç‰ˆï¼‰</h1>

  <div class="controls">
    <!-- â–¼ è¿½åŠ ï¼šãƒ•ã‚£ãƒ«ã‚¿ãƒ‘ãƒãƒ«ã®ãƒˆã‚°ãƒ« -->
    <button type="button" id="toggle-filters" aria-expanded="false" aria-controls="filter-panel">ğŸ” ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶</button>

    <!-- â–¼ è¿½åŠ ï¼šãƒ•ã‚£ãƒ«ã‚¿ãƒ‘ãƒãƒ«æœ¬ä½“ï¼ˆçŠ¶æ…‹ï¼æ®µä½ï¼å¹´é½¢ï¼‰ã€‚çµã‚Šè¾¼ã¿UIã®ã¿è¿½åŠ  -->
    <div id="filter-panel" hidden style="grid-column: 1 / -1;">
      <fieldset>
        <legend>çŠ¶æ…‹</legend>
        <label><input type="checkbox" class="filter-status" value="ç¾å½¹" checked> ç¾å½¹</label>
        <label><input type="checkbox" class="filter-status" value="å¼•é€€"> å¼•é€€</label>
        <label><input type="checkbox" class="filter-status" value="ç‰©æ•…"> ç‰©æ•…</label>
        <label><input type="checkbox" class="filter-status" value="é€€ä¼š"> é€€ä¼š</label>
      </fieldset>

      <fieldset style="margin-top:.4em;">
        <legend>æ®µä½</legend>
        <label><input type="checkbox" class="filter-dan" value="ä¹æ®µ"> ä¹æ®µ</label>
        <label><input type="checkbox" class="filter-dan" value="å…«æ®µ"> å…«æ®µ</label>
        <label><input type="checkbox" class="filter-dan" value="ä¸ƒæ®µ"> ä¸ƒæ®µ</label>
        <label><input type="checkbox" class="filter-dan" value="å…­æ®µ"> å…­æ®µ</label>
        <label><input type="checkbox" class="filter-dan" value="äº”æ®µ"> äº”æ®µ</label>
        <label><input type="checkbox" class="filter-dan" value="å››æ®µ"> å››æ®µ</label>
      </fieldset>

      <fieldset style="margin-top:.4em;">
        <legend>å¹´é½¢</legend>
        <input type="number" id="age-min" inputmode="numeric" placeholder="æœ€å°"> ã€œ
        <input type="number" id="age-max" inputmode="numeric" placeholder="æœ€å¤§">
      </fieldset>

      <div style="margin-top:.4em;">
        <button type="button" id="reset-filters">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>

    <!-- æ—¢å­˜ï¼šè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼‹ã‚µãƒãƒªï¼ˆå¤‰æ›´ãªã—ï¼‰ -->
    <div class="view-toggle" role="group" aria-label="è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰">
      <label><input type="radio" name="viewMode" id="view-table" value="table" checked> ä¸€è¦§</label>
      <label><input type="radio" name="viewMode" id="view-card"  value="card"> ã‚«ãƒ¼ãƒ‰</label>
    </div>
    <div id="status-summary" class="status-summary" aria-live="polite"></div>

    <!-- æ—¢å­˜ï¼šä¸¦ã³æ›¿ãˆUIï¼ˆãƒ©ãƒ™ãƒ«æ–‡è¨€ã®ã¿ãã®ã¾ã¾ï¼æ©Ÿèƒ½ã¯æ¤œç´¢ãƒœã‚¿ãƒ³ã§ä¸€æ‹¬é©ç”¨ï¼‰ -->
    <label for="sort-select">ä¸¦ã³æ›¿ãˆåŸºæº–:</label>
    <select id="sort-select">
      <option value="">-- ä¸¦ã³æ›¿ãˆæœªé¸æŠ --</option>
      <option value="kishiNumber">æ£‹å£«ç•ªå·</option>
      <option value="birthdate">ç”Ÿå¹´æœˆæ—¥</option>
      <option value="currentAge">ç¾å¹´é½¢</option>
      <option value="ageAtPromotion">å››æ®µæ˜‡æ®µæ™‚å¹´é½¢</option>
      <option value="dan">æ®µä½</option>
    </select>
    <div>
      <label><input type="radio" name="sortOrder" value="asc" checked> æ˜‡é †</label>
      <label><input type="radio" name="sortOrder" value="desc"> é™é †</label>
    </div>

    <!-- â–¼ ç½®æ›ï¼šå¾“æ¥ã®ã€Œä¸¦ã³æ›¿ãˆã‚‹ã€â†’ã€Œæ¤œç´¢ã€ãƒœã‚¿ãƒ³ã«ç½®æ›ï¼ˆæ©Ÿèƒ½ã¯ä¸€æ‹¬é©ç”¨ï¼‰ -->
    <button type="button" id="apply-filters">æ¤œç´¢</button>
  </div>

  <table id="mobile-table">
    <thead>
      <tr id="thead-row"></tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºç”¨ï¼ˆæ—¢å­˜ï¼‰ -->
  <div id="card-container" class="cards" hidden></div>

  <p style="margin-top:1em; display:flex; justify-content:space-between; align-items:center;">
    <a href="index.html?force=1">â–¶ PCç‰ˆã‚’è¡¨ç¤º</a>
    <a href="#" id="scrollTopLink">â–² ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>
  </p>

<script>
  // ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹ï¼ˆæ—¢å­˜ï¼‰
  document.getElementById('scrollTopLink').addEventListener('click', (e) => {
    e.preventDefault();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
</script>

<script>
let people = [];
let currentSortOrder = 'asc';
let currentView = localStorage.getItem('viewMode') || 'table'; // 'table' | 'card'

const labelMap = {
  kishiNumber: "æ£‹å£«ç•ªå·",
  birthdate: "ç”Ÿå¹´æœˆæ—¥",
  currentAge: "ç¾å¹´é½¢",
  ageAtPromotion: "å››æ®µæ˜‡æ®µæ™‚å¹´é½¢",
  dan: "æ®µä½"
};

const stateOrderAsc = { "ç¾å½¹": 0, "å¼•é€€": 1, "ç‰©æ•…": 2, "é€€ä¼š": 3 };
const rankOrderMap   = { "ä¹æ®µ": 9, "å…«æ®µ": 8, "ä¸ƒæ®µ": 7, "å…­æ®µ": 6, "äº”æ®µ": 5, "å››æ®µ": 4 };

/* ===== è£œåŠ©é–¢æ•°ï¼ˆæ—¢å­˜ï¼‰ ===== */
function parseDate(str){ const d=new Date(str); return isNaN(d)?null:d; }
function toNumber(str){ const n=Number(str); return isNaN(n)?Infinity:n; }
function diffYMD(a,b){
  if(!a||!b)return null;
  let y=b.getFullYear()-a.getFullYear(),
      m=b.getMonth()-a.getMonth(),
      d=b.getDate()-a.getDate();
  if(d<0){
    const pm=new Date(b.getFullYear(), b.getMonth(), 0);
    d+=pm.getDate(); m--;
  }
  if(m<0){ m+=12; y--; }
  return {y,m,d};
}
function formatYMD(p){ return p?`${p.y}æ­³${p.m}ãƒ¶æœˆ${p.d}æ—¥`:''; }

// ç¾åœ¨æ®µä½ã®åˆ°é”æ—¥ï¼ˆæ—¢å­˜ï¼‰
function getDanPromotionDate(p){
  switch(p.dan){
    case 'ä¹æ®µ': return p.d9 || null;
    case 'å…«æ®µ': return p.d8 || null;
    case 'ä¸ƒæ®µ': return p.d7 || null;
    case 'å…­æ®µ': return p.d6 || null;
    case 'äº”æ®µ': return p.d5 || null;
    case 'å››æ®µ': return p.prom || null;
    default: return null;
  }
}

/* ===== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆæ—¢å­˜ï¼‰ ===== */
async function loadData(){
  const res  = await fetch('kishi.csv');
  const text = await res.text();

  const rows = text.trim().split(/\r?\n/).map(r=>r.split(','));
  const header = rows.shift();
  const idx = name => header.findIndex(h=>h===name);
  const today = new Date();

  people = rows.map(cols=>{
    const birth = parseDate(cols[idx('ç”Ÿå¹´æœˆæ—¥')]);
    const prom  = parseDate(cols[idx('å››æ®µæ˜‡æ®µæ—¥')]);
    const d5 = parseDate(cols[idx('äº”æ®µæ˜‡æ®µæ—¥')]);
    const d6 = parseDate(cols[idx('å…­æ®µæ˜‡æ®µæ—¥')]);
    const d7 = parseDate(cols[idx('ä¸ƒæ®µæ˜‡æ®µæ—¥')]);
    const d8 = parseDate(cols[idx('å…«æ®µæ˜‡æ®µæ—¥')]);
    const d9 = parseDate(cols[idx('ä¹æ®µæ˜‡æ®µæ—¥')]);

    return {
      name:      (cols[idx('æ£‹å£«å')]||'').trim(),
      birthStr:  (cols[idx('ç”Ÿå¹´æœˆæ—¥')]||'').trim(),
      promStr:   (cols[idx('å››æ®µæ˜‡æ®µæ—¥')]||'').trim(),
      noStr:     (cols[idx('æ£‹å£«ç•ªå·')]||'').trim(),
      noNum:     toNumber(cols[idx('æ£‹å£«ç•ªå·')]),
      dan:       (cols[idx('æ®µä½')]||'').trim(),
      // â˜… ã‚¿ã‚¤ãƒˆãƒ«ä¿æŒè€…ãƒ©ãƒ³ã‚¯ï¼ˆ1ãŒæœ€ä¸Šä½ã€ç©ºã¯æœªä¿æŒâ†’Infinityæ‰±ã„ï¼‰
      titleRank: (cols[idx('ã‚¿ã‚¤ãƒˆãƒ«ä¿æŒè€…')]||'').trim(),
      // çŠ¶æ…‹ï¼ˆç¾å½¹/å¼•é€€/ç‰©æ•…/é€€ä¼šï¼‰
      status:    ((cols[idx('çŠ¶æ…‹')]||'ç¾å½¹')).trim(),

      birth, prom, d5, d6, d7, d8, d9,
      currentAgeParts: birth ? diffYMD(birth,today) : null,
      promoAgeParts: (birth&&prom) ? diffYMD(birth,prom) : null,
      currentAgeDays: birth ? Math.floor((today-birth)/86400000) : Infinity,
      promoAgeDays: (birth&&prom) ? Math.floor((prom-birth)/86400000) : Infinity
    };
  });
}

/* ===== æ®µä½ã‚½ãƒ¼ãƒˆï¼ˆæ—¢å­˜ï¼‰ ===== */
function sortByDan(list, order='asc'){
  const asc = (order==='asc');
  return [...list].sort((a,b)=>{
    // 1) çŠ¶æ…‹
    const as = stateOrderAsc[a.status] ?? 99;
    const bs = stateOrderAsc[b.status] ?? 99;
    if (as !== bs) return asc ? as - bs : bs - as;

    // 2) ç¾å½¹å†…ã¯ã‚¿ã‚¤ãƒˆãƒ«ä¿æŒè€…å„ªå…ˆï¼ˆ1ãŒæœ€ä¸Šä½ã€ç©ºã¯Infinityï¼‰
    if (a.status === 'ç¾å½¹' && b.status === 'ç¾å½¹') {
      const at = a.titleRank ? Number(a.titleRank) : Infinity;
      const bt = b.titleRank ? Number(b.titleRank) : Infinity;
      if (at !== bt) return asc ? at - bt : bt - at;

      // 3) æ®µä½ï¼ˆæ˜‡é †=ä¹â†’å››ï¼‰
      const ar = rankOrderMap[a.dan] ?? 0;
      const br = rankOrderMap[b.dan] ?? 0;
      if (ar !== br) return asc ? br - ar : ar - br;

      // 4) ç¾æ®µä½ã®åˆ°é”æ—¥ï¼ˆæ—©ã„=å°ã•ã„ã»ã©ä¸Šï¼‰
      const ad = getDanPromotionDate(a);
      const bd = getDanPromotionDate(b);
      const av = ad ? ad.getTime() : Infinity;
      const bv = bd ? bd.getTime() : Infinity;
      if (av !== bv) return asc ? av - bv : bv - av;

      // 5) æ£‹å£«ç•ªå·
      return asc ? a.noNum - b.noNum : b.noNum - a.noNum;
    }

    // ç¾å½¹ä»¥å¤–ã¯æ£‹å£«ç•ªå·ã§ä¸¦ã¹ã‚‹
    return asc ? a.noNum - b.noNum : b.noNum - a.noNum;
  });
}

/* ===== ãƒ†ãƒ¼ãƒ–ãƒ«æç”»ï¼ˆæ—¢å­˜ï¼‰ ===== */
function renderInitialTable(data){
  const thead = document.getElementById('thead-row');
  thead.innerHTML = `
    <th class="rank">é †ä½</th>
    <th>æ£‹å£«å</th>
    <th id="col-label">æ®µä½</th>
  `;
  const tbody = document.querySelector('#mobile-table tbody');
  tbody.innerHTML = data.map((p,i)=>`
    <tr>
      <td class="rank">${i+1}</td>
      <td>${p.name}</td>
      <td>${p.dan || ''}</td>
    </tr>
  `).join('');
}

function renderSortedTable(data, criterion){
  const labels = {
    kishiNumber: 'æ£‹å£«ç•ªå·',
    birthdate: 'ç”Ÿå¹´æœˆæ—¥',
    currentAge: 'ç¾å¹´é½¢',
    ageAtPromotion: 'å››æ®µæ˜‡æ®µæ™‚å¹´é½¢',
    dan: 'æ®µä½'
  };
  const thead = document.getElementById('thead-row');
  thead.innerHTML = `
    <th class="rank">é †ä½</th>
    <th>æ£‹å£«å</th>
    <th id="col-label">${labels[criterion] || 'æ®µä½'}</th>
  `;
  const tbody = document.querySelector('#mobile-table tbody');
  tbody.innerHTML = data.map((p,i)=>{
    let third = '';
    switch(criterion){
      case 'kishiNumber': third = p.noStr || ''; break;
      case 'birthdate': third = p.birthStr || ''; break;
      case 'currentAge': third = p.currentAgeParts ? formatYMD(p.currentAgeParts) : ''; break;
      case 'ageAtPromotion': third = p.promoAgeParts ? formatYMD(p.promoAgeParts) : ''; break;
      case 'dan': default: third = p.dan || ''; break;
    }
    return `
      <tr>
        <td class="rank">${i+1}</td>
        <td>${p.name}</td>
        <td>${third}</td>
      </tr>
    `;
  }).join('');
}

/* ===== ã‚«ãƒ¼ãƒ‰æç”»ï¼ˆæ—¢å­˜ï¼‰ ===== */
function renderCards(data, criterion) {
  const wrap = document.getElementById('card-container');
  if (!data || data.length === 0) {
    wrap.innerHTML = `<div class="empty-state">è©²å½“ã™ã‚‹æ£‹å£«ãŒã„ã¾ã›ã‚“</div>`;
    return;
  }
  wrap.innerHTML = data.map(p => {
    const statusClass = (p.status === 'ç¾å½¹') ? 'pill-status' : 'pill-status retired';
    const third =
      criterion === 'kishiNumber'    ? (p.noStr || '') :
      criterion === 'birthdate'      ? (p.birthStr || '') :
      criterion === 'currentAge'     ? (p.currentAgeParts ? formatYMD(p.currentAgeParts) : '') :
      criterion === 'ageAtPromotion' ? (p.promoAgeParts ? formatYMD(p.promoAgeParts) : '') :
                                       (p.dan || '');

    return `
      <article class="card">
        <div class="card-header">
          <div class="card-name">${p.name}</div>
          <div class="badge-dan">${p.dan || ''}</div>
        <div class="${statusClass}">${p.status}</div>
        </div>
        <div class="card-body">
          <div class="card-meta">æ£‹å£«ç•ªå·ï¼š${p.noStr || '-'}</div>
          <div>${labelMap[criterion || 'dan'] || 'æ®µä½'}ï¼š${third || '-'}</div>
          ${p.promStr ? `<div>å››æ®µæ˜‡æ®µæ—¥ï¼š${p.promStr}</div>` : ''}
          ${p.currentAgeParts ? `<div>ç¾å¹´é½¢ï¼š${formatYMD(p.currentAgeParts)}</div>` : ''}
        </div>
      </article>
    `;
  }).join('');
}

/* ===== ã‚µãƒãƒªè¡¨ç¤ºï¼ˆæ‹¡å¼µï¼šé¸æŠä¸­ãƒ•ã‚£ãƒ«ã‚¿ã®æ–‡è¨€åæ˜ ï¼‰ ===== */
function updateStatusSummary(list, criterion) {
  const sum = document.getElementById('status-summary');
  if (!sum) return;

  const orderRadio = document.querySelector('input[name="sortOrder"]:checked');
  const order = orderRadio ? orderRadio.value : 'asc';
  const orderLabel = (order === 'asc') ? 'æ˜‡é †' : 'é™é †';
  const critLabel = criterion ? (labelMap[criterion] || 'æ®µä½') : 'æ®µä½';
  const viewLabel = (currentView === 'card') ? 'ã‚«ãƒ¼ãƒ‰' : 'ä¸€è¦§';

  const statuses = [...document.querySelectorAll('.filter-status:checked')].map(cb=>cb.value);
  const dans = [...document.querySelectorAll('.filter-dan:checked')].map(cb=>cb.value);
  const amin = (document.getElementById('age-min')?.value ?? '');
  const amax = (document.getElementById('age-max')?.value ?? '');
  const ageLabel = (amin || amax) ? `${amin||'0'}ã€œ${amax||'âˆ'}æ­³` : 'æŒ‡å®šãªã—';

  sum.textContent =
    `è¡¨ç¤ºï¼š${viewLabel} ï¼ ä¸¦ã³ï¼š${critLabel}ãƒ»${orderLabel} ï¼ ` +
    `çŠ¶æ…‹ï¼š${statuses.length ? statuses.join('ãƒ»') : '(æœªé¸æŠ)'} ï¼ ` +
    `æ®µä½ï¼š${dans.length ? dans.join('ãƒ»') : 'ã™ã¹ã¦'} ï¼ ` +
    `å¹´é½¢ï¼š${ageLabel} ï¼ ä»¶æ•°ï¼š${(list || []).length}`;
}

/* ===== è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆæ—¢å­˜ï¼‰ ===== */
function setViewMode(mode) {
  currentView = mode;
  localStorage.setItem('viewMode', mode);
  const tableEl = document.getElementById('mobile-table');
  const cardEl  = document.getElementById('card-container');
  if (mode === 'card') {
    if (tableEl) tableEl.style.display = 'none';
    if (cardEl)  cardEl.hidden = false;
  } else {
    if (tableEl) tableEl.style.display = 'table';
    if (cardEl)  cardEl.hidden = true;
  }
}

/* ===== ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ ===== */
function getCheckedValues(sel){
  return Array.from(document.querySelectorAll(sel))
    .filter(el=>el.checked)
    .map(el=>el.value);
}

function getFilteredPeople(){
  const checkedStatus = getCheckedValues('.filter-status');
  // çŠ¶æ…‹ãŒ0ä»¶é¸æŠï¼çµæœ0ä»¶ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ„æ€ã‚’å°Šé‡ï¼‰
  if (checkedStatus.length === 0) return [];

  const checkedDan = getCheckedValues('.filter-dan');

  const aminEl = document.getElementById('age-min');
  const amaxEl = document.getElementById('age-max');
  const useMin = aminEl && aminEl.value !== '';
  const useMax = amaxEl && amaxEl.value !== '';
  const min = useMin ? Number(aminEl.value) : -Infinity;
  const max = useMax ? Number(amaxEl.value) : Infinity;

  return people.filter(p=>{
    // çŠ¶æ…‹
    if (!checkedStatus.includes(p.status)) return false;

    // æ®µä½ï¼ˆæœªé¸æŠï¼ãƒ•ã‚£ãƒ«ã‚¿ç„¡åŠ¹ï¼‰
    if (checkedDan.length && !checkedDan.includes(p.dan)) return false;

    // å¹´é½¢
    if (useMin || useMax) {
      if (!p.currentAgeParts) return false;
      const y = p.currentAgeParts.y;
      if (y < min || y > max) return false;
    }
    return true;
  });
}

/* ===== åˆæœŸè¡¨ç¤ºï¼ˆæ—¢å­˜ã®æ„å›³ã‚’ç¶­æŒï¼šæ®µä½åŸºæº–ã§æ˜‡é †åˆæœŸï¼‰ ===== */
function renderMobileInitial(){
  const base = sortByDan(getFilteredPeople(), 'asc');
  if (currentView === 'card') {
    renderCards(base, 'dan');
  } else {
    renderInitialTable(base);
  }
  updateStatusSummary(base, 'dan');
}

/* ===== æ¤œç´¢ãƒœã‚¿ãƒ³ï¼šãƒ•ã‚£ãƒ«ã‚¿ï¼‹ä¸¦ã³æ›¿ãˆä¸€æ‹¬é©ç”¨ ===== */
function applyFiltersAndSort(){
  const orderRadio = document.querySelector('input[name="sortOrder"]:checked');
  currentSortOrder = orderRadio ? orderRadio.value : 'asc';
  const criterion = document.getElementById('sort-select').value || 'dan';

  const base = getFilteredPeople();
  let sorted;
  switch(criterion){
    case 'kishiNumber':
      sorted = [...base].sort((a,b)=> currentSortOrder==='asc' ? a.noNum-b.noNum : b.noNum-a.noNum);
      break;
    case 'birthdate':
      sorted = [...base].sort((a,b)=>{
        const av=a.birth ? a.birth.getTime() : Infinity;
        const bv=b.birth ? b.birth.getTime() : Infinity;
        return currentSortOrder==='asc' ? av-bv : bv-av;
      });
      break;
    case 'currentAge':
      sorted = [...base].sort((a,b)=> currentSortOrder==='asc' ? a.currentAgeDays-b.currentAgeDays : b.currentAgeDays-a.currentAgeDays);
      break;
    case 'ageAtPromotion':
      sorted = [...base].sort((a,b)=> currentSortOrder==='asc' ? a.promoAgeDays-b.promoAgeDays : b.promoAgeDays-a.promoAgeDays);
      break;
    case 'dan':
      sorted = sortByDan(base, currentSortOrder);
      break;
    default:
      sorted = sortByDan(base, currentSortOrder);
      break;
  }

  if (currentView === 'card') {
    renderCards(sorted, criterion);
  } else {
    renderSortedTable(sorted, criterion);
  }
  updateStatusSummary(sorted, criterion);

  // â–¼ è¿½åŠ ï¼šæ¤œç´¢ç¢ºå®šå¾Œã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã€ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’åŒæœŸï¼ˆæœ€å°å·®åˆ†ï¼‰
  const panel = document.getElementById('filter-panel');
  const btn   = document.getElementById('toggle-filters');
  if (panel && !panel.hidden) {
    panel.hidden = true;
    btn?.classList.remove('active');
    btn?.setAttribute('aria-expanded', 'false');
    btn?.blur();
  }
  // ä»»æ„ï¼šçµæœã‚µãƒãƒªãƒ¼ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  document.getElementById('status-summary')?.scrollIntoView({ behavior:'smooth', block:'start' });
}

/* ===== èµ·å‹•æ™‚ã®åˆæœŸåŒ–ï¼ˆæ—¢å­˜ï¼‹æœ€ä½é™ã®è¿½åŠ ï¼‰ ===== */
(async()=>{
  await loadData();

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ‘ãƒãƒ«é–‹é–‰ï¼ˆç½®æ›ï¼šé–‹é–‰çŠ¶æ…‹ã«åˆã‚ã›ã¦ active/aria ã‚’åŒæœŸï¼‰
  const toggleBtn = document.getElementById('toggle-filters');
  toggleBtn?.addEventListener('click', ()=>{
    const p = document.getElementById('filter-panel');
    if (!p) return;
    const willOpen = p.hidden;   // ã“ã‚Œã‹ã‚‰é–‹ãã‹ï¼Ÿ
    p.hidden = !p.hidden;        // è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    toggleBtn.classList.toggle('active', willOpen);
    toggleBtn.setAttribute('aria-expanded', String(willOpen));
  });

  // ãƒªã‚»ãƒƒãƒˆï¼šç¾å½¹ã®ã¿ONï¼æ®µä½å…¨OFFï¼å¹´é½¢æœªæŒ‡å®š
  document.getElementById('reset-filters')?.addEventListener('click', ()=>{
    document.querySelectorAll('.filter-status').forEach(cb=> cb.checked = (cb.value === 'ç¾å½¹'));
    document.querySelectorAll('.filter-dan').forEach(cb=> cb.checked = false);
    const aminEl = document.getElementById('age-min'); if (aminEl) aminEl.value = '';
    const amaxEl = document.getElementById('age-max'); if (amaxEl) amaxEl.value = '';
  });

  // æ¤œç´¢ãƒœã‚¿ãƒ³ï¼šä¸€æ‹¬é©ç”¨
  document.getElementById('apply-filters')?.addEventListener('click', applyFiltersAndSort);

  setViewMode(currentView);
  const vt = document.getElementById('view-table');
  const vc = document.getElementById('view-card');
  if (vt && vc) { if (currentView==='card'){ vc.checked=true; } else { vt.checked=true; } }

  // åˆæœŸæç”»ï¼ˆç¾å½¹ã®ã¿ãƒ»æ®µä½æ˜‡é †ï¼‰
  renderMobileInitial();

  // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆæ—¢å­˜ã®ã¾ã¾ï¼‰
  document.getElementById('view-table').addEventListener('change', (e)=>{
    if (e.target.checked) {
      setViewMode('table');
      const c = document.getElementById('sort-select').value || 'dan';
      const base = getFilteredPeople();
      const list = (c==='dan') ? sortByDan(base, currentSortOrder) : base;
      if (c==='dan') renderInitialTable(list); else renderSortedTable(list, c);
      updateStatusSummary(list, c);
    }
  });
  document.getElementById('view-card').addEventListener('change', (e)=>{
    if (e.target.checked) {
      setViewMode('card');
      const c = document.getElementById('sort-select').value || 'dan';
      const base = getFilteredPeople();
      const list = (c==='dan') ? sortByDan(base, currentSortOrder) : base;
      renderCards(list, c);
      updateStatusSummary(list, c);
    }
  });
})();
</script>
</body>
</html>